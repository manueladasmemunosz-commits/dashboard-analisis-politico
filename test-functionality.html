<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard Functionality</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #testLog { background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Dashboard Test Suite</h1>
    <button onclick="runAllTests()">Ejecutar Todos los Tests</button>
    <div id="results"></div>
    <h2>Log de Tests:</h2>
    <div id="testLog"></div>

    <!-- Scripts necesarios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="report-generator.js"></script>

    <script>
        const results = document.getElementById('results');
        const testLog = document.getElementById('testLog');
        let testsPassed = 0;
        let testsFailed = 0;

        function log(message, type = 'info') {
            console.log(message);
            testLog.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            testLog.scrollTop = testLog.scrollHeight;
        }

        function addResult(message, success) {
            const div = document.createElement('div');
            div.className = `test-result ${success ? 'success' : 'error'}`;
            div.textContent = message;
            results.appendChild(div);

            if (success) {
                testsPassed++;
            } else {
                testsFailed++;
            }
        }

        // Test 1: Verificar que PapaParse esté disponible
        function testPapaParse() {
            log('Test 1: Verificando PapaParse...');
            try {
                if (typeof Papa !== 'undefined') {
                    // Test básico de parsing
                    const testCSV = 'likes,replies,text\n10,5,Test message';
                    Papa.parse(testCSV, {
                        header: true,
                        complete: (results) => {
                            if (results.data.length > 0 && results.data[0].likes === '10') {
                                addResult('✓ PapaParse funciona correctamente', true);
                                log('PapaParse test passed');
                            } else {
                                addResult('✗ PapaParse no procesa datos correctamente', false);
                            }
                        },
                        error: (error) => {
                            addResult(`✗ Error en PapaParse: ${error.message}`, false);
                        }
                    });
                } else {
                    addResult('✗ PapaParse no está disponible', false);
                }
            } catch (error) {
                addResult(`✗ Error cargando PapaParse: ${error.message}`, false);
                log(`PapaParse error: ${error.message}`);
            }
        }

        // Test 2: Verificar Chart.js
        function testChartJS() {
            log('Test 2: Verificando Chart.js...');
            try {
                if (typeof Chart !== 'undefined') {
                    // Crear canvas temporal para test
                    const canvas = document.createElement('canvas');
                    canvas.width = 100;
                    canvas.height = 100;

                    const testChart = new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: ['Test'],
                            datasets: [{
                                label: 'Test Data',
                                data: [10]
                            }]
                        },
                        options: {
                            animation: false
                        }
                    });

                    if (testChart) {
                        testChart.destroy();
                        addResult('✓ Chart.js funciona correctamente', true);
                        log('Chart.js test passed');
                    } else {
                        addResult('✗ Chart.js no puede crear gráficos', false);
                    }
                } else {
                    addResult('✗ Chart.js no está disponible', false);
                }
            } catch (error) {
                addResult(`✗ Error en Chart.js: ${error.message}`, false);
                log(`Chart.js error: ${error.message}`);
            }
        }

        // Test 3: Verificar ReportGenerator
        function testReportGenerator() {
            log('Test 3: Verificando ReportGenerator...');
            try {
                if (typeof ReportGenerator !== 'undefined') {
                    const generator = new ReportGenerator();
                    const testData = [
                        { likes: 10, replies: 5, text: 'Test post', date: '2024-01-01' }
                    ];

                    const report = generator.generateCSVReport({ analytics: { totalPosts: 1, totalLikes: 10, totalReplies: 5, engagementRate: '15.0', topPosts: testData }, wordcloud: { uniqueWords: 1, topWords: [{word: 'test', count: 1}] }});

                    if (report && report.format === 'csv' && report.data.includes('Total Posts,1')) {
                        addResult('✓ ReportGenerator funciona correctamente', true);
                        log('ReportGenerator test passed');
                    } else {
                        addResult('✗ ReportGenerator no genera reportes correctos', false);
                    }
                } else {
                    addResult('✗ ReportGenerator no está disponible', false);
                }
            } catch (error) {
                addResult(`✗ Error en ReportGenerator: ${error.message}`, false);
                log(`ReportGenerator error: ${error.message}`);
            }
        }

        // Test 4: Verificar procesamiento de datos
        function testDataProcessing() {
            log('Test 4: Verificando procesamiento de datos...');
            try {
                // Simular función processDataRow
                function processDataRow(row) {
                    if (!row || (!row.likes && !row.replies && !row.text)) {
                        return null;
                    }
                    const likes = +(row.likes) || 0;
                    const replies = +(row.replies) || 0;
                    const text = (row.text || '').trim();

                    if (!text && likes === 0 && replies === 0) {
                        return null;
                    }

                    return {
                        likes,
                        replies,
                        text,
                        date: row.date || new Date().toISOString().split('T')[0],
                        engagement: likes + replies
                    };
                }

                const testRow = { likes: '10', replies: '5', text: 'Test message', date: '2024-01-01' };
                const processed = processDataRow(testRow);

                if (processed && processed.likes === 10 && processed.replies === 5 && processed.engagement === 15) {
                    addResult('✓ Procesamiento de datos funciona correctamente', true);
                    log('Data processing test passed');
                } else {
                    addResult('✗ Error en procesamiento de datos', false);
                    log(`Data processing failed. Result: ${JSON.stringify(processed)}`);
                }
            } catch (error) {
                addResult(`✗ Error en procesamiento de datos: ${error.message}`, false);
                log(`Data processing error: ${error.message}`);
            }
        }

        // Test 5: Verificar CSV de muestra
        async function testSampleCSV() {
            log('Test 5: Verificando CSV de muestra...');
            try {
                const response = await fetch('sample-data.csv');
                if (response.ok) {
                    const csvText = await response.text();
                    if (csvText.includes('likes,replies,text,date') && csvText.length > 100) {
                        addResult('✓ CSV de muestra disponible y válido', true);
                        log(`Sample CSV test passed. Size: ${csvText.length} characters`);
                    } else {
                        addResult('✗ CSV de muestra no es válido', false);
                    }
                } else {
                    addResult('✗ CSV de muestra no disponible', false);
                }
            } catch (error) {
                addResult(`✗ Error cargando CSV de muestra: ${error.message}`, false);
                log(`Sample CSV error: ${error.message}`);
            }
        }

        async function runAllTests() {
            log('=== INICIANDO TESTS DEL DASHBOARD ===');
            results.innerHTML = '';
            testsPassed = 0;
            testsFailed = 0;

            // Ejecutar tests
            testPapaParse();

            // Esperar un poco antes del siguiente test
            setTimeout(() => {
                testChartJS();
                setTimeout(() => {
                    testReportGenerator();
                    setTimeout(() => {
                        testDataProcessing();
                        setTimeout(async () => {
                            await testSampleCSV();

                            // Resultado final
                            setTimeout(() => {
                                log(`=== RESUMEN FINAL ===`);
                                log(`Tests passed: ${testsPassed}`);
                                log(`Tests failed: ${testsFailed}`);
                                log(`Success rate: ${((testsPassed/(testsPassed+testsFailed))*100).toFixed(1)}%`);

                                const summaryDiv = document.createElement('div');
                                summaryDiv.className = `test-result ${testsFailed === 0 ? 'success' : 'info'}`;
                                summaryDiv.innerHTML = `<strong>Resumen: ${testsPassed} exitosos, ${testsFailed} fallaron (${((testsPassed/(testsPassed+testsFailed))*100).toFixed(1)}% éxito)</strong>`;
                                results.appendChild(summaryDiv);
                            }, 100);
                        }, 100);
                    }, 100);
                }, 100);
            }, 500);
        }

        // Ejecutar tests automáticamente al cargar la página
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>