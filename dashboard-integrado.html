<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pro Integrado - An√°lisis Completo de Redes Sociales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .dashboard-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px 20px;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .main-content {
            padding: 30px;
            overflow-y: auto;
            max-height: 100vh;
            position: relative;
        }

        .sidebar h1 {
            font-size: 1.6rem;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 700;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Main Content Tabs */
        .main-nav-tabs {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
        }

        .main-nav-tab {
            flex: 1;
            text-align: center;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: #666;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
        }

        .main-nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .main-nav-tab:hover:not(.active) {
            background: #f8f9fa;
            color: #333;
        }

        /* File Upload Section */
        .file-upload-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
            text-align: center;
        }

        .file-upload-section:hover {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f2ff, #e6e8ff);
            transform: translateY(-2px);
        }

        .file-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            background: #f8f9fa;
        }

        .upload-info {
            color: #666;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        /* Global Stats */
        .global-stats {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .global-stats h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1rem;
        }

        /* Global Filters */
        .global-filters {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
        }

        .global-filters h3 {
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
        }

        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .chip {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            backdrop-filter: blur(10px);
        }

        .chip:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .chip.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            font-weight: 600;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .checkbox-container:hover {
            background: rgba(255,255,255,0.2);
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .checkbox-container label {
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(255,255,255,0.6);
            background: rgba(255,255,255,0.15);
        }

        /* Control Buttons */
        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-sidebar {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 14px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-sidebar:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.4);
        }

        .btn-sidebar.secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-sidebar.secondary:hover {
            box-shadow: 0 6px 25px rgba(108, 117, 125, 0.4);
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeInUp 0.6s ease-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 30px;
        }

        .chart-widget {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .chart-widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f3f4;
            flex-wrap: wrap;
            gap: 15px;
        }

        .widget-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .widget-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 280px;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-label-small {
            font-size: 0.8rem;
            color: #666;
            font-weight: 600;
            min-width: 60px;
        }

        .chart-type-selector, .social-selector, .date-selector {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .chart-type-selector:hover, .social-selector:hover, .date-selector:hover {
            border-color: #667eea;
        }

        .color-picker {
            width: 40px;
            height: 30px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-picker:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .widget-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .widget-btn:hover {
            background: #5a6fd8;
        }

        /* Word Cloud Styles */
        .wordcloud-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 28px;
            padding: 40px;
            backdrop-filter: blur(25px);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .wordcloud-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 30% 70%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
            pointer-events: none;
        }

        .wordcloud-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            position: relative;
            z-index: 1;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .slider-container:hover {
            background: white;
            border-color: rgba(102, 126, 234, 0.4);
        }

        .slider-label {
            font-size: 0.9rem;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
        }

        .slider-value {
            font-size: 0.95rem;
            color: #667eea;
            font-weight: 700;
            min-width: 30px;
            text-align: center;
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: rgba(102, 126, 234, 0.2);
            outline: none;
            width: 140px;
            transition: background 0.3s ease;
        }

        input[type="range"]:hover {
            background: rgba(102, 126, 234, 0.3);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }

        .select {
            background: white;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 12px 18px;
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 150px;
            color: #333;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .select:hover {
            border-color: rgba(102, 126, 234, 0.4);
        }

        .select option {
            background: white;
            color: #333;
            padding: 10px;
        }

        .canvas-wrapper {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            position: relative;
            z-index: 1;
        }

        #wordCloudCanvas {
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-width: 100%;
            height: auto;
            cursor: default;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }

        #wordCloudCanvas:hover {
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2);
        }

        .info {
            text-align: center;
            color: #333;
            font-size: 1rem;
            margin-top: 20px;
            padding: 18px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            line-height: 1.5;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 25px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .stat {
            text-align: center;
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            min-width: 120px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .stat:hover::before {
            transform: translateX(0);
        }

        .stat:hover {
            background: white;
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Exclusions */
        .exclusions-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .excluded-words {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
            padding: 15px;
            background: rgba(255, 243, 205, 0.3);
            border: 1px solid rgba(255, 234, 167, 0.5);
            border-radius: 12px;
        }

        .excluded-word {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(253, 121, 168, 0.3);
            font-weight: 500;
        }

        .excluded-word:hover {
            background: linear-gradient(135deg, #e84393, #d63384);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 25px rgba(253, 121, 168, 0.4);
        }

        .excluded-word .remove-x {
            font-weight: bold;
            margin-left: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            color: white;
            font-size: 1.4rem;
            padding: 60px;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 35px;
            border-radius: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 30px;
            font-weight: bold;
            position: absolute;
            right: 25px;
            top: 20px;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .modal-header {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 20px;
            margin-bottom: 25px;
        }

        .post-text {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
            line-height: 1.7;
        }

        .engagement-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .engagement-stat {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .engagement-stat .number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            margin: 15px 10px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                height: auto;
            }

            .main-nav-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .wordcloud-controls {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* Multi-select styles for wordcloud */
        .multi-select {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            user-select: none;
            color: #333;
            position: relative;
            overflow: hidden;
        }

        .checkbox-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
            transition: left 0.5s;
        }

        .checkbox-item:hover::before {
            left: 100%;
        }

        .checkbox-item:hover {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .checkbox-item.checked {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            color: white;
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            opacity: 0;
            position: absolute;
        }

        .filter-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
        }

        .filter-section .filter-label {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
        }

        #exclusionsSection {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>Dashboard Pro Integrado</h1>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchView('analytics')">üìä Analytics</button>
                <button class="nav-tab" onclick="switchView('wordcloud')">‚òÅÔ∏è Nube de Palabras</button>
            </div>

            <div class="file-upload-section">
                <h3 style="margin-bottom: 15px; color: #333; font-weight: 600;">üìä Cargar Datos</h3>
                <input type="file" id="csvFile" accept=".csv" class="file-input" />
                <div class="upload-info">
                    Formato CSV con datos de redes sociales
                </div>
            </div>

            <div class="global-stats">
                <h3>üìà Estad√≠sticas Generales</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Posts:</span>
                    <span class="stat-value" id="totalPosts">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Usuarios √önicos:</span>
                    <span class="stat-value" id="uniqueUsers">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Likes:</span>
                    <span class="stat-value" id="totalLikes">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Engagement Promedio:</span>
                    <span class="stat-value" id="avgEngagement">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Menciones:</span>
                    <span class="stat-value" id="totalMentions">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Hashtags:</span>
                    <span class="stat-value" id="totalHashtags">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Sentimiento Positivo:</span>
                    <span class="stat-value" id="positiveSentiment">-</span>
                </div>
            </div>

            <div class="global-filters">
                <h3>üéõÔ∏è Filtros Globales</h3>

                <div class="filter-group">
                    <label class="filter-label">Redes Sociales:</label>
                    <div id="socialCheckboxes">
                        <!-- Checkboxes will be populated dynamically -->
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="widget-btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="selectAllSocial()">Todas</button>
                        <button class="widget-btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" onclick="selectNoneSocial()">Ninguna</button>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Per√≠odo:</label>
                    <div class="chips-container" id="globalDateChips">
                        <div class="chip active" data-value="all">Todo</div>
                        <div class="chip" data-value="7days">7 d√≠as</div>
                        <div class="chip" data-value="30days">30 d√≠as</div>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">B√∫squeda:</label>
                    <input type="text" class="search-input" id="globalSearch" placeholder="Buscar en contenido...">
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn-sidebar" onclick="loadSampleData()">üéØ Cargar Demo</button>
                <button class="btn-sidebar secondary" onclick="refreshAllData()">üîÑ Actualizar Todo</button>
                <button class="btn-sidebar secondary" onclick="resetAllFilters()">üóëÔ∏è Limpiar Filtros</button>
                <button class="btn-sidebar secondary" onclick="exportAllData()">üìÑ Exportar Reporte</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="loading" class="loading">
                <h2>üöÄ Dashboard Profesional Integrado</h2>
                <p>An√°lisis completo de redes sociales con visualizaciones avanzadas</p>
                <p style="margin-top: 20px; font-size: 1rem; opacity: 0.8;">Carga tu archivo CSV o usa el demo para comenzar</p>
            </div>

            <!-- Analytics Content -->
            <div id="analytics-content" class="content-section">
                <div class="main-nav-tabs">
                    <button class="main-nav-tab active" onclick="switchAnalyticsTab('charts')">üìä Gr√°ficos B√°sicos</button>
                    <button class="main-nav-tab" onclick="switchAnalyticsTab('advanced')">üî¨ An√°lisis Avanzado</button>
                    <button class="main-nav-tab" onclick="switchAnalyticsTab('network')">üï∏Ô∏è An√°lisis de Red</button>
                </div>

                <!-- Charts Section -->
                <div id="charts-section" class="charts-grid">
                    <!-- Timeline Chart -->
                    <div class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üìÖ Actividad Temporal</h3>
                            <div class="widget-controls">
                                <div class="control-row">
                                    <span class="control-label-small">Tipo:</span>
                                    <select class="chart-type-selector" onchange="updateChartType('timeline', this.value)">
                                        <option value="line">L√≠nea</option>
                                        <option value="bar">Barras</option>
                                        <option value="area">√Årea</option>
                                    </select>
                                    <span class="control-label-small">Por:</span>
                                    <select class="date-selector" onchange="updateTimelineAxis(this.value)">
                                        <option value="day">D√≠a</option>
                                        <option value="hour">Hora</option>
                                        <option value="week">Semana</option>
                                        <option value="month">Mes</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <span class="control-label-small">Color:</span>
                                    <input type="color" class="color-picker" value="#667eea" onchange="updateChartColor('timeline', this.value)">
                                    <button class="widget-btn" onclick="updateChart('timeline')">Actualizar</button>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Posts Chart -->
                    <div class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üèÜ Top Posts por Likes</h3>
                            <div class="widget-controls">
                                <div class="control-row">
                                    <span class="control-label-small">Tipo:</span>
                                    <select class="chart-type-selector" onchange="updateChartType('topPosts', this.value)">
                                        <option value="bar">Barras</option>
                                        <option value="horizontalBar">Barras Horizontales</option>
                                        <option value="doughnut">Dona</option>
                                    </select>
                                    <span class="control-label-small">Top:</span>
                                    <select class="social-selector" onchange="updateChartLimit('topPosts', this.value)">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <span class="control-label-small">Color:</span>
                                    <input type="color" class="color-picker" value="#667eea" onchange="updateChartColor('topPosts', this.value)">
                                    <button class="widget-btn" onclick="updateChart('topPosts')">Actualizar</button>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="topPostsChart"></canvas>
                        </div>
                        <p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 10px;">
                            üèÜ Haz clic en las barras para ver detalles del post
                        </p>
                    </div>

                    <!-- Engagement Chart -->
                    <div class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üí¨ An√°lisis de Engagement</h3>
                            <div class="widget-controls">
                                <div class="control-row">
                                    <span class="control-label-small">Tipo:</span>
                                    <select class="chart-type-selector" onchange="updateChartType('engagement', this.value)">
                                        <option value="scatter">Dispersi√≥n</option>
                                        <option value="bubble">Burbujas</option>
                                        <option value="line">L√≠nea</option>
                                    </select>
                                    <span class="control-label-small">Color:</span>
                                    <input type="color" class="color-picker" value="#667eea" onchange="updateChartColor('engagement', this.value)">
                                    <button class="widget-btn" onclick="updateChart('engagement')">Actualizar</button>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="engagementChart"></canvas>
                        </div>
                        <p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 10px;">
                            üí¨ Haz clic en los puntos para ver detalles del post
                        </p>
                    </div>

                    <!-- Active Users Chart -->
                    <div class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üî• Usuarios M√°s Activos</h3>
                            <div class="widget-controls">
                                <div class="control-row">
                                    <span class="control-label-small">Tipo:</span>
                                    <select class="chart-type-selector" onchange="updateChartType('activeUsers', this.value)">
                                        <option value="horizontalBar">Barras Horizontales</option>
                                        <option value="bar">Barras</option>
                                        <option value="doughnut">Dona</option>
                                    </select>
                                    <span class="control-label-small">Top:</span>
                                    <select class="social-selector" onchange="updateChartLimit('activeUsers', this.value)">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="15">15</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <span class="control-label-small">Color:</span>
                                    <input type="color" class="color-picker" value="#e74c3c" onchange="updateChartColor('activeUsers', this.value)">
                                    <button class="widget-btn" onclick="updateChart('activeUsers')">Actualizar</button>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="activeUsersChart"></canvas>
                        </div>
                        <p style="text-align: center; color: #666; font-size: 0.8rem; margin-top: 10px;">
                            üìä Haz clic en cualquier barra para ver las publicaciones del usuario
                        </p>
                    </div>
                </div>

                <!-- Advanced Section (initially hidden) -->
                <div id="advanced-section" class="charts-grid hidden">
                    <div class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üòä An√°lisis de Sentimiento</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="sentimentChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title"># An√°lisis de Hashtags</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="hashtagsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Network Section (initially hidden) -->
                <div id="network-section" class="charts-grid hidden">
                    <div class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">üîó Red de Menciones</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="mentionsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Word Cloud Content -->
            <div id="wordcloud-content" class="content-section">
                <div class="wordcloud-container">
                    <!-- Word Cloud Controls -->
                    <div class="filter-section">
                        <label class="filter-label">Tipo de Contenido</label>
                        <div class="multi-select" id="contentFilters">
                            <div class="checkbox-item checked">
                                <input type="checkbox" id="content_words" checked>
                                <label for="content_words">Palabras</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="content_phrases">
                                <label for="content_phrases">Frases</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="content_hashtags">
                                <label for="content_hashtags">Hashtags</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="content_mentions">
                                <label for="content_mentions">Menciones</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="content_longwords">
                                <label for="content_longwords">Palabras Largas</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <label class="filter-label">Categor√≠as Tem√°ticas</label>
                        <div class="multi-select" id="categoryFilters">
                            <div class="checkbox-item checked">
                                <input type="checkbox" id="cat_all" checked>
                                <label for="cat_all">Todas</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cat_politics">
                                <label for="cat_politics">Pol√≠tica</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cat_economy">
                                <label for="cat_economy">Econom√≠a</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cat_education">
                                <label for="cat_education">Educaci√≥n</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cat_technology">
                                <label for="cat_technology">Tecnolog√≠a</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="cat_social">
                                <label for="cat_social">Social</label>
                            </div>
                        </div>
                    </div>

                    <div class="wordcloud-controls">
                        <div class="slider-container">
                            <span class="slider-label">Cantidad:</span>
                            <input type="range" id="wordCountSlider" min="10" max="80" value="35">
                            <span id="wordCountDisplay" class="slider-value">35</span>
                        </div>

                        <div class="slider-container">
                            <span class="slider-label">Min. Frecuencia:</span>
                            <input type="range" id="minFrequency" min="1" max="10" value="2">
                            <span id="minFreqDisplay" class="slider-value">2</span>
                        </div>

                        <select class="select" id="colorTheme">
                            <option value="vibrant">Vibrante</option>
                            <option value="cool">Colores Fr√≠os</option>
                            <option value="warm">Colores C√°lidos</option>
                            <option value="monochrome">Monocrom√°tico</option>
                            <option value="political">Pol√≠tico</option>
                            <option value="gradient">Gradientes</option>
                        </select>

                        <button class="btn-primary" onclick="generateWordCloud()">üîÑ Actualizar Nube</button>
                    </div>

                    <div class="canvas-wrapper">
                        <canvas id="wordCloudCanvas" width="1200" height="600"></canvas>
                    </div>

                    <div class="info" id="wordCloudInfo">
                        Carga datos CSV o haz click en "Cargar Demo" para comenzar
                    </div>

                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="totalWords">-</div>
                            <div class="stat-label">Palabras √önicas</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="placedWords">-</div>
                            <div class="stat-label">Mostradas</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="successRate">-</div>
                            <div class="stat-label">Tasa √âxito</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="wordCloudPosts">-</div>
                            <div class="stat-label">Posts</div>
                        </div>
                    </div>

                    <div id="exclusionsSection" class="exclusions-container">
                        <label class="filter-label">Palabras Excluidas (Click en la nube para a√±adir)</label>
                        <div class="excluded-words" id="excludedWords"></div>
                        <button class="btn-primary clear-btn" id="clearExclusions" style="background: linear-gradient(135deg, #E74C3C, #C0392B);">Limpiar Exclusiones</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h3 id="modalUserName">Usuario</h3>
                <div style="color: #666; font-size: 0.9rem;">
                    <span id="modalUsername">@usuario</span> ‚Ä¢
                    <span id="modalFollowers">0</span> seguidores ‚Ä¢
                    <span id="modalDate">fecha</span>
                </div>
            </div>
            <div class="post-text" id="modalPostText">Texto del post...</div>
            <div class="engagement-stats">
                <div class="engagement-stat">
                    <div class="number" id="modalLikes">0</div>
                    <div>Likes</div>
                </div>
                <div class="engagement-stat">
                    <div class="number" id="modalReplies">0</div>
                    <div>Respuestas</div>
                </div>
                <div class="engagement-stat">
                    <div class="number" id="modalShared">0</div>
                    <div>Compartidos</div>
                </div>
                <div class="engagement-stat">
                    <div class="number" id="modalSource">-</div>
                    <div>Fuente</div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" id="openPostBtn">üîó Abrir Post Original</button>
                <button class="btn-primary" style="background: #6c757d;" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // VARIABLES GLOBALES UNIFICADAS
        // =============================================================================

        let dashboardData = {
            raw: [],
            filtered: [],
            sources: [],
            charts: {},
            chartTypes: {
                timeline: 'line',
                topPosts: 'bar',
                engagement: 'scatter',
                activeUsers: 'horizontalBar'
            },
            chartColors: {
                timeline: '#667eea',
                topPosts: '#667eea',
                engagement: '#667eea',
                activeUsers: '#e74c3c'
            },
            chartLimits: {
                topPosts: 10,
                activeUsers: 10
            },
            timelineAxis: 'day',
            filters: {
                social: ['todas'],
                date: 'all',
                search: ''
            }
        };

        // Variables para Word Cloud
        let wordCloudSize = 35;
        let minFrequency = 2;
        let excludedWords = new Set();
        let clickableWords = [];
        let currentView = 'analytics';
        let currentAnalyticsTab = 'charts';

        // =============================================================================
        // FUNCIONES DE NAVEGACI√ìN
        // =============================================================================

        function switchView(view) {
            currentView = view;

            // Update sidebar nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            if (view === 'analytics') {
                document.getElementById('analytics-content').classList.add('active');
                if (dashboardData.raw.length > 0) {
                    createAllCharts();
                }
            } else if (view === 'wordcloud') {
                document.getElementById('wordcloud-content').classList.add('active');
                if (dashboardData.raw.length > 0) {
                    generateWordCloud();
                }
            }
        }

        function switchAnalyticsTab(tab) {
            currentAnalyticsTab = tab;

            // Update main nav tabs
            document.querySelectorAll('.main-nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide sections
            document.getElementById('charts-section').classList.toggle('hidden', tab !== 'charts');
            document.getElementById('advanced-section').classList.toggle('hidden', tab !== 'advanced');
            document.getElementById('network-section').classList.toggle('hidden', tab !== 'network');

            // Create appropriate charts
            if (dashboardData.raw.length > 0) {
                switch(tab) {
                    case 'charts':
                        createBasicCharts();
                        break;
                    case 'advanced':
                        createAdvancedCharts();
                        break;
                    case 'network':
                        createNetworkCharts();
                        break;
                }
            }
        }

        // =============================================================================
        // FUNCIONES DE DATOS UNIFICADAS
        // =============================================================================

        function processCSV(csvContent) {
            Papa.parse(csvContent, {
                header: true,
                dynamicTyping: false,
                skipEmptyLines: true,
                complete: function(results) {
                    dashboardData.raw = results.data.map(row => ({
                        ...row,
                        likes: parseInt(row.likes) || 0,
                        replies: parseInt(row.replies) || 0,
                        shared: parseInt(row.shared) || 0,
                        user_followers: parseInt(row.user_followers) || 0,
                        user_username: String(row.user_username || ''),
                        user_name: String(row.user_name || ''),
                        text: String(row.text || ''),
                        source: String(row.source || 'otros').toLowerCase(),
                        created: row.created || new Date().toISOString()
                    })).filter(row => row.text && row.text.length > 0);

                    initDashboard();
                }
            });
        }

        function loadSampleData() {
            const sampleTexts = [
                'Chile necesita mayor #seguridad ciudadana pol√≠ticas efectivas @gobierno desarrollo nacional',
                'Propuesta mejorar #educaci√≥n nacional futuro j√≥venes estudiantes chilenos sistema educativo',
                'An√°lisis pol√≠tico profundo situaci√≥n actual pa√≠s desaf√≠os estructurales importantes #democracia',
                '#debate pol√≠ticas p√∫blicas transparencia @gobierno responsabilidad institucional democr√°tica',
                'Jos√© Antonio Kast propone reformas estructurales importantes Chile moderno #desarrollo',
                '@evelynmatthei presenta programa gobierno innovador desarrollo social econ√≥mico #pol√≠ticas',
                'Chile requiere liderazgo responsable comprometido valores democr√°ticos fundamentales #democracia',
                '#econom√≠a chilena crecimiento sustentable pol√≠ticas inclusivas innovaci√≥n #tecnolog√≠a',
                'Pol√≠ticas p√∫blicas necesitan transparencia participaci√≥n ciudadana activa #democracia',
                'Propuesta educativa integral mejorar calidad acceso equitativo sistema #educacional',
                'Tecnolog√≠a blockchain revoluciona sector financiero chileno #innovaci√≥n #fintech @bancocentral',
                'Inteligencia artificial transformar√° mercado laboral pr√≥ximos a√±os #ia #tecnolog√≠a',
                '@universidadchile investiga energ√≠as renovables sustentabilidad ambiental #ciencia',
                'Startups chilenas destacan internacionalmente desarrollo software innovador #emprendimiento',
                'Educaci√≥n digital herramienta clave futuro estudiantes chilenos #educaci√≥n #digital',
                'Salud mental juventud requiere atenci√≥n urgente pol√≠ticas preventivas #salud #j√≥venes',
                'Cambio clim√°tico afecta agricultura tradicional Chile adaptaci√≥n necesaria #medioambiente',
                'Inversi√≥n extranjera directa impulsa crecimiento econ√≥mico regional #econom√≠a #inversi√≥n',
                '@sernac protege derechos consumidores chilenos transparencia mercado #consumidores',
                'Infraestructura digital rural conectividad desaf√≠o importante desarrollo #conectividad'
            ];

            const sources = ['twitter', 'facebook', 'instagram', 'tiktok', 'linkedin'];
            const users = ['analista_pol', 'ciudadano_act', 'academico_soc', 'periodista_inv', 'medio_noticias'];
            const sampleData = [];

            for (let i = 0; i < 1000; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 60));

                const baseText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                let finalText = baseText;

                if (Math.random() > 0.7) {
                    finalText += ' @usuario' + Math.floor(Math.random() * 100);
                }
                if (Math.random() > 0.6) {
                    const extraHashtags = ['#importante', '#chile2024', '#pol√≠tica', '#social', '#cambio', '#futuro'];
                    finalText += ' ' + extraHashtags[Math.floor(Math.random() * extraHashtags.length)];
                }

                sampleData.push({
                    user_username: users[Math.floor(Math.random() * users.length)] + (i % 60),
                    user_name: `Usuario Demo ${i % 60}`,
                    user_followers: Math.floor(Math.random() * 100000) + 100,
                    source: sources[Math.floor(Math.random() * sources.length)],
                    created: date.toISOString(),
                    likes: Math.floor(Math.random() * 2000) + 1,
                    replies: Math.floor(Math.random() * 300),
                    shared: Math.floor(Math.random() * 500),
                    text: finalText
                });
            }

            dashboardData.raw = sampleData;
            dashboardData.charts = {};
            initDashboard();
        }

        function applyFilters() {
            dashboardData.filtered = dashboardData.raw.filter(post => {
                const socialFilters = dashboardData.filters.social;
                const passesSourceFilter = socialFilters.includes('todas') || socialFilters.includes(post.source);

                if (!passesSourceFilter) return false;

                if (dashboardData.filters.date !== 'all') {
                    const postDate = new Date(post.created);
                    const now = new Date();
                    const daysDiff = Math.floor((now - postDate) / (1000 * 60 * 60 * 24));

                    if (dashboardData.filters.date === '7days' && daysDiff > 7) return false;
                    if (dashboardData.filters.date === '30days' && daysDiff > 30) return false;
                }

                if (dashboardData.filters.search) {
                    const searchTerm = dashboardData.filters.search.toLowerCase();
                    const searchableText = (post.text + ' ' + post.user_username).toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }

                return true;
            });

            updateStats();

            // Update appropriate visualizations based on current view
            if (currentView === 'analytics') {
                switch(currentAnalyticsTab) {
                    case 'charts':
                        createBasicCharts();
                        break;
                    case 'advanced':
                        createAdvancedCharts();
                        break;
                    case 'network':
                        createNetworkCharts();
                        break;
                }
            } else if (currentView === 'wordcloud') {
                generateWordCloud();
            }
        }

        function updateStats() {
            const totalPosts = dashboardData.filtered.length;
            const uniqueUsers = new Set(dashboardData.filtered.map(d => d.user_username)).size;
            const totalLikes = dashboardData.filtered.reduce((sum, d) => sum + d.likes, 0);
            const avgEngagement = totalPosts > 0 ? Math.round(totalLikes / totalPosts * 100) / 100 : 0;

            // Calculate advanced metrics
            let totalMentions = 0;
            let totalHashtags = 0;
            let positiveSentiment = 0;

            dashboardData.filtered.forEach(post => {
                totalMentions += (post.text.match(/@\w+/g) || []).length;
                totalHashtags += (post.text.match(/#\w+/g) || []).length;

                // Simple sentiment analysis
                const positiveWords = ['bueno', 'excelente', 'genial', 'perfecto', 'incre√≠ble', 'fant√°stico'];
                if (positiveWords.some(word => post.text.toLowerCase().includes(word))) {
                    positiveSentiment++;
                }
            });

            const positivePercentage = totalPosts > 0 ? Math.round((positiveSentiment / totalPosts) * 100) : 0;

            // Update stats
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            };

            updateElement('totalPosts', totalPosts.toLocaleString());
            updateElement('uniqueUsers', uniqueUsers.toLocaleString());
            updateElement('totalLikes', totalLikes.toLocaleString());
            updateElement('avgEngagement', avgEngagement);
            updateElement('totalMentions', totalMentions.toLocaleString());
            updateElement('totalHashtags', totalHashtags.toLocaleString());
            updateElement('positiveSentiment', `${positivePercentage}%`);
            updateElement('wordCloudPosts', totalPosts.toLocaleString());
        }

        // =============================================================================
        // FUNCIONES DE GR√ÅFICOS UNIFICADAS
        // =============================================================================

        function groupDataByTime(data, groupBy) {
            const groups = {};

            data.forEach(post => {
                if (!post.created) return;

                const date = new Date(post.created);
                let key;

                switch (groupBy) {
                    case 'hour':
                        key = `${String(date.getHours()).padStart(2, '0')}:00`;
                        break;
                    case 'day':
                        key = date.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const startOfWeek = new Date(date);
                        const day = date.getDay();
                        const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                        startOfWeek.setDate(diff);
                        key = `Semana del ${startOfWeek.getDate()}/${startOfWeek.getMonth() + 1}`;
                        break;
                    case 'month':
                        const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                                          'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                        key = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                        break;
                    default:
                        key = date.toISOString().split('T')[0];
                }

                groups[key] = (groups[key] || 0) + 1;
            });

            return groups;
        }

        function createBasicCharts() {
            createTimeline();
            createTopPosts();
            createEngagement();
            createActiveUsers();
        }

        function createAdvancedCharts() {
            createSentimentChart();
            createHashtagsChart();
        }

        function createNetworkCharts() {
            createMentionsChart();
        }

        function createAllCharts() {
            if (currentView === 'analytics') {
                switch(currentAnalyticsTab) {
                    case 'charts':
                        createBasicCharts();
                        break;
                    case 'advanced':
                        createAdvancedCharts();
                        break;
                    case 'network':
                        createNetworkCharts();
                        break;
                }
            }
        }

        function createTimeline() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            const data = dashboardData.filtered;

            if (dashboardData.charts.timeline) dashboardData.charts.timeline.destroy();

            const dateGroups = groupDataByTime(data, dashboardData.timelineAxis);
            const dates = Object.keys(dateGroups).sort();
            const counts = dates.map(date => dateGroups[date]);

            const chartType = dashboardData.chartTypes.timeline;
            const color = dashboardData.chartColors.timeline;

            dashboardData.charts.timeline = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Posts',
                        data: counts,
                        borderColor: color,
                        backgroundColor: chartType === 'area' ? color + '33' : color,
                        borderWidth: 3,
                        fill: chartType === 'area',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createTopPosts() {
            const ctx = document.getElementById('topPostsChart').getContext('2d');
            const data = dashboardData.filtered;
            const limit = dashboardData.chartLimits.topPosts;
            const topPosts = data.filter(post => post.likes > 0).sort((a, b) => b.likes - a.likes).slice(0, limit);

            if (dashboardData.charts.topPosts) dashboardData.charts.topPosts.destroy();

            const chartType = dashboardData.chartTypes.topPosts;
            const color = dashboardData.chartColors.topPosts;

            dashboardData.charts.topPosts = new Chart(ctx, {
                type: chartType === 'horizontalBar' ? 'bar' : chartType,
                data: {
                    labels: topPosts.map((post, i) => `${i + 1}. ${post.user_username.substring(0, 10)}...`),
                    datasets: [{
                        data: topPosts.map(post => post.likes),
                        backgroundColor: chartType === 'doughnut' ?
                            [color, color + 'CC', color + '99', color + '66', color + '33'] : color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: chartType === 'horizontalBar' ? 'y' : 'x',
                    plugins: { legend: { display: chartType === 'doughnut' } },
                    scales: chartType === 'doughnut' ? {} : {
                        [chartType === 'horizontalBar' ? 'x' : 'y']: { beginAtZero: true }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            showPostModal(topPosts[elements[0].index]);
                        }
                    }
                }
            });
        }

        function createEngagement() {
            const ctx = document.getElementById('engagementChart').getContext('2d');
            const data = dashboardData.filtered;
            const engagementData = data.filter(post => post.likes > 0 || post.replies > 0).slice(0, 200);

            if (dashboardData.charts.engagement) dashboardData.charts.engagement.destroy();

            const color = dashboardData.chartColors.engagement;
            const chartType = dashboardData.chartTypes.engagement;

            if (chartType === 'scatter') {
                dashboardData.charts.engagement = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Posts',
                            data: engagementData.map((post, index) => ({
                                x: post.likes,
                                y: post.replies,
                                postIndex: index
                            })),
                            backgroundColor: color + '99',
                            borderColor: color,
                            borderWidth: 1,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Likes' },
                                beginAtZero: true
                            },
                            y: {
                                title: { display: true, text: 'Respuestas' },
                                beginAtZero: true
                            }
                        },
                        onClick: function(event, elements) {
                            if (elements.length > 0) {
                                const point = elements[0];
                                const post = engagementData[point.index];
                                showPostModal(post);
                            }
                        }
                    }
                });
            } else if (chartType === 'bubble') {
                dashboardData.charts.engagement = new Chart(ctx, {
                    type: 'bubble',
                    data: {
                        datasets: [{
                            label: 'Engagement',
                            data: engagementData.map((post, index) => ({
                                x: post.likes,
                                y: post.replies,
                                r: Math.sqrt(post.shared) / 2 + 5,
                                postIndex: index
                            })),
                            backgroundColor: color + '66',
                            borderColor: color,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Likes' },
                                beginAtZero: true
                            },
                            y: {
                                title: { display: true, text: 'Respuestas' },
                                beginAtZero: true
                            }
                        },
                        onClick: function(event, elements) {
                            if (elements.length > 0) {
                                const point = elements[0];
                                const post = engagementData[point.index];
                                showPostModal(post);
                            }
                        }
                    }
                });
            }
        }

        function createActiveUsers() {
            const ctx = document.getElementById('activeUsersChart').getContext('2d');
            const data = dashboardData.filtered;
            const limit = dashboardData.chartLimits.activeUsers;
            const userPostCounts = {};

            data.forEach(post => {
                if (post.user_username) {
                    userPostCounts[post.user_username] = (userPostCounts[post.user_username] || 0) + 1;
                }
            });

            const activeUsers = Object.entries(userPostCounts).sort((a, b) => b[1] - a[1]).slice(0, limit);

            if (dashboardData.charts.activeUsers) dashboardData.charts.activeUsers.destroy();

            const chartType = dashboardData.chartTypes.activeUsers;
            const color = dashboardData.chartColors.activeUsers;

            dashboardData.charts.activeUsers = new Chart(ctx, {
                type: chartType === 'horizontalBar' ? 'bar' : chartType,
                data: {
                    labels: activeUsers.map(user => user[0].substring(0, 15)),
                    datasets: [{
                        data: activeUsers.map(user => user[1]),
                        backgroundColor: chartType === 'doughnut' ?
                            [color, color + 'CC', color + '99', color + '66', color + '33', color + '22'] : color
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: chartType === 'horizontalBar' ? 'y' : 'x',
                    plugins: {
                        legend: { display: chartType === 'doughnut' }
                    },
                    scales: chartType === 'doughnut' ? {} : {
                        [chartType === 'horizontalBar' ? 'x' : 'y']: { beginAtZero: true }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const username = activeUsers[elements[0].index][0];
                            showUserPosts(username);
                        }
                    }
                }
            });
        }

        function createSentimentChart() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            const data = dashboardData.filtered;

            if (dashboardData.charts.sentiment) dashboardData.charts.sentiment.destroy();

            // Simple sentiment analysis
            const sentiment = { positive: 0, neutral: 0, negative: 0 };

            data.forEach(post => {
                const text = post.text.toLowerCase();
                const positiveWords = ['bueno', 'excelente', 'genial', 'perfecto', 'incre√≠ble', 'fant√°stico'];
                const negativeWords = ['malo', 'terrible', 'horrible', 'p√©simo', 'awful'];

                if (positiveWords.some(word => text.includes(word))) {
                    sentiment.positive++;
                } else if (negativeWords.some(word => text.includes(word))) {
                    sentiment.negative++;
                } else {
                    sentiment.neutral++;
                }
            });

            dashboardData.charts.sentiment = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positivo', 'Neutral', 'Negativo'],
                    datasets: [{
                        data: [sentiment.positive, sentiment.neutral, sentiment.negative],
                        backgroundColor: ['#2ecc71', '#95a5a6', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        function createHashtagsChart() {
            const ctx = document.getElementById('hashtagsChart').getContext('2d');
            const data = dashboardData.filtered;

            if (dashboardData.charts.hashtags) dashboardData.charts.hashtags.destroy();

            const hashtagCounts = {};
            data.forEach(post => {
                const hashtags = post.text.match(/#\w+/g) || [];
                hashtags.forEach(hashtag => {
                    const cleanHashtag = hashtag.toLowerCase();
                    hashtagCounts[cleanHashtag] = (hashtagCounts[cleanHashtag] || 0) + 1;
                });
            });

            const topHashtags = Object.entries(hashtagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            dashboardData.charts.hashtags = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topHashtags.map(([hashtag]) => hashtag),
                    datasets: [{
                        label: 'Frecuencia',
                        data: topHashtags.map(([, count]) => count),
                        backgroundColor: '#f39c12'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function createMentionsChart() {
            const ctx = document.getElementById('mentionsChart').getContext('2d');
            const data = dashboardData.filtered;

            if (dashboardData.charts.mentions) dashboardData.charts.mentions.destroy();

            const mentionCounts = {};
            data.forEach(post => {
                const mentions = post.text.match(/@\w+/g) || [];
                mentions.forEach(mention => {
                    const cleanMention = mention.toLowerCase();
                    mentionCounts[cleanMention] = (mentionCounts[cleanMention] || 0) + 1;
                });
            });

            const topMentions = Object.entries(mentionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            dashboardData.charts.mentions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topMentions.map(([mention]) => mention),
                    datasets: [{
                        label: 'Menciones',
                        data: topMentions.map(([, count]) => count),
                        backgroundColor: '#9b59b6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        // =============================================================================
        // FUNCIONES DE WORD CLOUD
        // =============================================================================

        function setupWordCloudEventListeners() {
            const wordSlider = document.getElementById('wordCountSlider');
            if (wordSlider) {
                wordSlider.addEventListener('input', function() {
                    wordCloudSize = parseInt(this.value);
                    document.getElementById('wordCountDisplay').textContent = this.value;

                    if (dashboardData.raw.length > 0) {
                        clearTimeout(window.wordTimeout);
                        window.wordTimeout = setTimeout(generateWordCloud, 200);
                    }
                });
            }

            const freqSlider = document.getElementById('minFrequency');
            if (freqSlider) {
                freqSlider.addEventListener('input', function() {
                    minFrequency = parseInt(this.value);
                    document.getElementById('minFreqDisplay').textContent = this.value;

                    if (dashboardData.raw.length > 0) {
                        clearTimeout(window.freqTimeout);
                        window.freqTimeout = setTimeout(generateWordCloud, 300);
                    }
                });
            }

            const colorTheme = document.getElementById('colorTheme');
            if (colorTheme) {
                colorTheme.addEventListener('change', function() {
                    if (dashboardData.raw.length > 0) {
                        generateWordCloud();
                    }
                });
            }

            setupMultiSelectListeners();
            setupExclusionListeners();
            setupCanvasClickListeners();
        }

        function setupCanvasClickListeners() {
            setTimeout(() => {
                const canvas = document.getElementById('wordCloudCanvas');
                if (!canvas) return;

                canvas.addEventListener('click', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const clickX = x * scaleX;
                    const clickY = y * scaleY;

                    const clickedWord = findWordAtPosition(clickX, clickY);
                    if (clickedWord) {
                        excludeWord(clickedWord.text);
                    }
                });

                canvas.addEventListener('mousemove', function(e) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const mouseX = x * scaleX;
                    const mouseY = y * scaleY;

                    const wordAtPosition = findWordAtPosition(mouseX, mouseY);
                    canvas.style.cursor = wordAtPosition ? 'pointer' : 'default';

                    if (wordAtPosition) {
                        canvas.title = `Click para excluir: "${wordAtPosition.text}"`;
                    } else {
                        canvas.title = '';
                    }
                });
            }, 100);
        }

        function setupMultiSelectListeners() {
            document.querySelectorAll('#contentFilters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const item = this.closest('.checkbox-item');
                    if (this.checked) {
                        item.classList.add('checked');
                    } else {
                        item.classList.remove('checked');
                    }

                    if (dashboardData.raw.length > 0) {
                        generateWordCloud();
                    }
                });
            });

            document.querySelectorAll('#categoryFilters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const item = this.closest('.checkbox-item');
                    if (this.checked) {
                        item.classList.add('checked');
                    } else {
                        item.classList.remove('checked');
                    }

                    if (this.id === 'cat_all') {
                        if (this.checked) {
                            document.querySelectorAll('#categoryFilters input[type="checkbox"]').forEach(cb => {
                                if (cb.id !== 'cat_all') {
                                    cb.checked = false;
                                    cb.closest('.checkbox-item').classList.remove('checked');
                                }
                            });
                        }
                    } else {
                        if (this.checked) {
                            const allCheckbox = document.getElementById('cat_all');
                            if (allCheckbox && allCheckbox.checked) {
                                allCheckbox.checked = false;
                                allCheckbox.closest('.checkbox-item').classList.remove('checked');
                            }
                        }
                    }

                    if (dashboardData.raw.length > 0) {
                        generateWordCloud();
                    }
                });
            });
        }

        function setupExclusionListeners() {
            const clearExclusionsBtn = document.getElementById('clearExclusions');
            if (clearExclusionsBtn) {
                clearExclusionsBtn.addEventListener('click', function() {
                    excludedWords.clear();
                    updateExcludedWordsDisplay();
                    if (dashboardData.raw.length > 0) {
                        generateWordCloud();
                    }
                });
            }
        }

        function findWordAtPosition(x, y) {
            for (const word of clickableWords) {
                const wordLeft = word.x - word.width / 2;
                const wordRight = word.x + word.width / 2;
                const wordTop = word.y - word.height / 2;
                const wordBottom = word.y + word.height / 2;

                if (x >= wordLeft && x <= wordRight && y >= wordTop && y <= wordBottom) {
                    return word;
                }
            }
            return null;
        }

        function excludeWord(word) {
            excludedWords.add(word.toLowerCase());
            updateExcludedWordsDisplay();

            if (dashboardData.raw.length > 0) {
                generateWordCloud();
            }
        }

        function updateExcludedWordsDisplay() {
            const container = document.getElementById('excludedWords');
            const section = document.getElementById('exclusionsSection');

            if (!container || !section) return;

            if (excludedWords.size === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            let html = '';
            excludedWords.forEach(word => {
                html += `
                    <div class="excluded-word" onclick="removeExclusion('${word}')">
                        ${word}
                        <span class="remove-x">√ó</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function removeExclusion(word) {
            excludedWords.delete(word);
            updateExcludedWordsDisplay();
            if (dashboardData.raw.length > 0) {
                generateWordCloud();
            }
        }

        function getActiveFilters() {
            const activeContentTypes = [];
            const activeCategories = [];

            document.querySelectorAll('#contentFilters input[type="checkbox"]:checked').forEach(cb => {
                activeContentTypes.push(cb.id.replace('content_', ''));
            });

            document.querySelectorAll('#categoryFilters input[type="checkbox"]:checked').forEach(cb => {
                activeCategories.push(cb.id.replace('cat_', ''));
            });

            return { activeContentTypes, activeCategories };
        }

        function generateWordCloud() {
            const canvas = document.getElementById('wordCloudCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const filters = getActiveFilters();

            const filteredData = dashboardData.filtered;

            if (filteredData.length === 0) {
                showEmptyCanvas(ctx, 'No hay datos para los filtros seleccionados');
                return;
            }

            // Clear canvas
            const gradient = ctx.createLinearGradient(0, 0, ctx.canvas.width, ctx.canvas.height);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(0.5, '#fafbfc');
            gradient.addColorStop(1, '#f8f9fa');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            try {
                let allItems = [];

                filters.activeContentTypes.forEach(type => {
                    let items = [];

                    switch (type) {
                        case 'words':
                            items = extractWords(filteredData);
                            break;
                        case 'phrases':
                            items = extractPhrases(filteredData);
                            break;
                        case 'hashtags':
                            items = extractHashtags(filteredData);
                            break;
                        case 'mentions':
                            items = extractMentions(filteredData);
                            break;
                        case 'longwords':
                            items = extractLongWords(filteredData);
                            break;
                    }

                    items = items.map(([item, count]) => [item, count, type]);
                    allItems = allItems.concat(items);
                });

                const combined = {};
                allItems.forEach(([item, count, type]) => {
                    const lowerItem = item.toLowerCase();
                    if (excludedWords.has(lowerItem)) return;

                    if (combined[lowerItem]) {
                        combined[lowerItem].count += count;
                    } else {
                        combined[lowerItem] = { count, type };
                    }
                });

                let finalItems = Object.entries(combined).map(([item, data]) => [
                    item, data.count, data.type
                ]);

                finalItems = finalItems.filter(([item, count, type]) => {
                    return !excludedWords.has(item.toLowerCase());
                });

                if (!filters.activeCategories.includes('all')) {
                    finalItems = filterByCategories(finalItems, filters.activeCategories);
                }

                finalItems = finalItems.filter(([item, count]) => count >= minFrequency);

                const topItems = finalItems
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, wordCloudSize);

                if (topItems.length === 0) {
                    showEmptyCanvas(ctx, 'Sin elementos para los filtros seleccionados');
                    return;
                }

                renderWordCloud(ctx, topItems, filteredData.length);

            } catch (error) {
                console.error('Error generando nube:', error);
                showEmptyCanvas(ctx, 'Error al procesar los datos');
            }
        }

        function extractWords(data) {
            const stopwords = new Set([
                'el', 'la', 'de', 'que', 'y', 'a', 'en', 'un', 'es', 'se', 'no', 'te', 'lo', 'le', 'da', 'su', 'por', 'son', 'con', 'para', 'como', 'las', 'si', 'del', 'los', 'al', 'una', 'sus', 'me', 'yo', 'muy', 'ya', 'm√°s', 'todo', 'pero', 'cuando', 'ver', 'sin', 'puede', 'ese', 'donde', 'quien', 'estado', 'eso', 'est√°', 'tambi√©n', 'hacer', 'otro', 'hasta', 'desde', 'porque', 'esta', 'hab√≠a', 'cada', 'cual', 'poco', 'vez', 'bien', 'solo', 'as√≠', 'entonces', 'ahora', 'aqu√≠', 'd√≠a', 'tanto', 'forma', 'sido', 'parte', 'despu√©s', 'mismo', 'van', 'hace', 'debe',
                'http', 'https', 'www', 'com', 'org', 'net'
            ]);

            const wordCount = {};
            data.forEach(post => {
                let text = String(post.text || '')
                    .toLowerCase()
                    .replace(/https?:\/\/[^\s]+/g, ' ')
                    .replace(/www\.[^\s]+/g, ' ')
                    .replace(/@\w+/g, ' ')
                    .replace(/#\w+/g, ' ')
                    .replace(/[^\w\s√°√©√≠√≥√∫√±√º]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                const words = text.split(' ').filter(word => {
                    if (word.length <= 3) return false;
                    if (stopwords.has(word)) return false;
                    if (/^\d+$/.test(word)) return false;

                    const cleanWord = word.replace(/[^\w√°√©√≠√≥√∫√±√º]/g, '').toLowerCase();
                    if (excludedWords.has(cleanWord)) return false;

                    return true;
                });

                words.forEach(word => {
                    const cleanWord = word.replace(/[^\w√°√©√≠√≥√∫√±√º]/g, '').toLowerCase();
                    if (cleanWord.length > 3 && !excludedWords.has(cleanWord)) {
                        wordCount[cleanWord] = (wordCount[cleanWord] || 0) + 1;
                    }
                });
            });

            return Object.entries(wordCount);
        }

        function extractPhrases(data) {
            const phrases = {};
            data.forEach(post => {
                const words = String(post.text || '')
                    .toLowerCase()
                    .replace(/[^\w\s√°√©√≠√≥√∫√±√º]/g, ' ')
                    .split(' ')
                    .filter(w => w.length > 3);

                for (let i = 0; i < words.length - 1; i++) {
                    const phrase = `${words[i]} ${words[i + 1]}`;
                    if (!excludedWords.has(phrase.toLowerCase()) &&
                        !excludedWords.has(words[i]) &&
                        !excludedWords.has(words[i + 1])) {
                        phrases[phrase] = (phrases[phrase] || 0) + 1;
                    }
                }
            });
            return Object.entries(phrases);
        }

        function extractHashtags(data) {
            const hashtags = {};
            data.forEach(post => {
                const matches = String(post.text || '').match(/#\w+/g);
                if (matches) {
                    matches.forEach(tag => {
                        const cleanTag = tag.toLowerCase();
                        if (!excludedWords.has(cleanTag)) {
                            hashtags[cleanTag] = (hashtags[cleanTag] || 0) + 1;
                        }
                    });
                }
            });
            return Object.entries(hashtags);
        }

        function extractMentions(data) {
            const mentions = {};
            data.forEach(post => {
                const matches = String(post.text || '').match(/@\w+/g);
                if (matches) {
                    matches.forEach(mention => {
                        const cleanMention = mention.toLowerCase();
                        if (!excludedWords.has(cleanMention)) {
                            mentions[cleanMention] = (mentions[cleanMention] || 0) + 1;
                        }
                    });
                }
            });
            return Object.entries(mentions);
        }

        function extractLongWords(data) {
            const longWords = {};
            data.forEach(post => {
                const words = String(post.text || '')
                    .toLowerCase()
                    .replace(/[^\w\s√°√©√≠√≥√∫√±√º]/g, ' ')
                    .split(' ')
                    .filter(w => w.length >= 8);

                words.forEach(word => {
                    const cleanWord = word.toLowerCase();
                    if (!excludedWords.has(cleanWord)) {
                        longWords[cleanWord] = (longWords[cleanWord] || 0) + 1;
                    }
                });
            });
            return Object.entries(longWords);
        }

        function filterByCategories(items, activeCategories) {
            const categoryKeywords = {
                politics: ['gobierno', 'presidente', 'pol√≠tica', 'congreso', 'elecciones', 'candidato', 'partido', 'democracia', 'constituci√≥n', 'kast', 'matthei', 'boric'],
                economy: ['econom√≠a', 'econ√≥mico', 'pib', 'inflaci√≥n', 'empleo', 'trabajo', 'empresa', 'inversi√≥n', 'mercado', 'banco', 'dinero'],
                education: ['educaci√≥n', 'educativo', 'escuela', 'universidad', 'estudiante', 'profesor', 'ense√±anza', 'conocimiento'],
                technology: ['tecnolog√≠a', 'digital', 'internet', 'innovaci√≥n', 'desarrollo', 'software', 'inteligencia', 'artificial'],
                social: ['social', 'sociedad', 'comunidad', 'familia', 'derechos', 'igualdad', 'justicia', 'salud']
            };

            return items.filter(([item]) => {
                const itemLower = item.toLowerCase();
                return activeCategories.some(category => {
                    const keywords = categoryKeywords[category] || [];
                    return keywords.some(keyword =>
                        itemLower.includes(keyword) || keyword.includes(itemLower)
                    );
                });
            });
        }

        function renderWordCloud(ctx, items, dataCount = null) {
            clickableWords = [];

            const colorTheme = document.getElementById('colorTheme').value;
            const colors = {
                vibrant: ['#E74C3C', '#3498DB', '#2ECC71', '#F39C12', '#9B59B6', '#1ABC9C', '#E67E22', '#E91E63'],
                cool: ['#3498DB', '#2980B9', '#1ABC9C', '#16A085', '#9B59B6', '#8E44AD', '#34495E', '#2C3E50'],
                warm: ['#E74C3C', '#C0392B', '#F39C12', '#E67E22', '#D35400', '#E91E63', '#FF5722', '#F57C00'],
                monochrome: ['#2C3E50', '#34495E', '#5D6D7E', '#85929E', '#566573', '#273746', '#1B2631', '#212F3C'],
                political: ['#C0392B', '#2980B9', '#27AE60', '#8E44AD', '#D35400', '#16A085', '#2C3E50', '#7D3C98'],
                gradient: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7']
            }[colorTheme] || ['#667eea'];

            const centerX = ctx.canvas.width / 2;
            const centerY = ctx.canvas.height / 2;

            const maxCount = items[0][1];
            const minCount = items[items.length - 1][1];
            const countRange = Math.max(maxCount - minCount, 1);

            const baseFontSize = Math.max(14, 40 - wordCloudSize * 0.3);
            const maxFontSize = Math.max(70, 140 - wordCloudSize * 0.8);

            const wordsWithProps = items.map(([item, count, type], index) => {
                const normalizedCount = (count - minCount) / countRange;
                const exponentialScale = Math.pow(normalizedCount, 0.4);
                let fontSize = baseFontSize + (exponentialScale * (maxFontSize - baseFontSize));

                if (index === 0) fontSize *= 2.8;
                else if (index < 2) fontSize *= 2.2;
                else if (index < 4) fontSize *= 1.8;
                else if (index < 8) fontSize *= 1.4;
                else if (index < 15) fontSize *= 1.2;

                fontSize = Math.round(fontSize);

                const canRotate = item.length > 8 && type !== 'hashtags' && type !== 'mentions';
                const rotation = canRotate && Math.random() > 0.7 ? (Math.random() > 0.5 ? 90 : -90) : 0;

                ctx.save();
                ctx.font = `bold ${fontSize}px Inter, Arial`;
                ctx.rotate(rotation * Math.PI / 180);
                const textMetrics = ctx.measureText(item);
                ctx.restore();

                const width = rotation === 0 ? textMetrics.width : fontSize * 0.8;
                const height = rotation === 0 ? fontSize : textMetrics.width;

                let color = colors[index % colors.length];
                if (type === 'hashtags') color = '#1DA1F2';
                else if (type === 'mentions') color = '#E91E63';

                return {
                    text: item,
                    count,
                    type,
                    fontSize,
                    width,
                    height,
                    rotation,
                    color: adjustColorIntensity(color, 0.8 + normalizedCount * 0.2),
                    importance: index,
                    placed: false,
                    x: 0,
                    y: 0
                };
            });

            const placedWords = [];
            const maxRadius = Math.min(ctx.canvas.width, ctx.canvas.height) / 2 - 30;
            const pixelMap = new Set();

            function addToPixelMap(x, y, width, height) {
                const margin = 2;
                const step = 3;

                for (let px = x - width/2 - margin; px <= x + width/2 + margin; px += step) {
                    for (let py = y - height/2 - margin; py <= y + height/2 + margin; py += step) {
                        if (px >= 0 && px < ctx.canvas.width && py >= 0 && py < ctx.canvas.height) {
                            pixelMap.add(`${Math.round(px)},${Math.round(py)}`);
                        }
                    }
                }
            }

            function checkPixelCollision(x, y, width, height) {
                const margin = 2;
                const step = 4;

                for (let px = x - width/2 - margin; px <= x + width/2 + margin; px += step) {
                    for (let py = y - height/2 - margin; py <= y + height/2 + margin; py += step) {
                        if (pixelMap.has(`${Math.round(px)},${Math.round(py)}`)) {
                            return true;
                        }
                    }
                }
                return false;
            }

            function isInCanvas(x, y, width, height) {
                return x - width/2 > 10 && x + width/2 < ctx.canvas.width - 10 &&
                       y - height/2 > 10 && y + height/2 < ctx.canvas.height - 10;
            }

            function placeWordIntelligent(wordObj) {
                const maxAttempts = wordObj.importance < 5 ? 300 : 150;

                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    const maxRadiusForWord = maxRadius * (0.3 + (wordObj.importance / items.length) * 0.7);
                    const angle = (attempt * 2.618) % (Math.PI * 2);
                    const radius = Math.sqrt(attempt / maxAttempts) * maxRadiusForWord;

                    const x = centerX + Math.cos(angle) * radius;
                    const y = centerY + Math.sin(angle) * radius;

                    if (isInCanvas(x, y, wordObj.width, wordObj.height) &&
                        !checkPixelCollision(x, y, wordObj.width, wordObj.height)) {
                        return { x, y };
                    }
                }

                return null;
            }

            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const sortedWords = [...wordsWithProps].sort((a, b) => b.fontSize - a.fontSize);

            sortedWords.forEach((wordObj) => {
                const position = placeWordIntelligent(wordObj);

                if (position) {
                    wordObj.x = position.x;
                    wordObj.y = position.y;
                    wordObj.placed = true;

                    ctx.save();
                    ctx.translate(wordObj.x, wordObj.y);
                    if (wordObj.rotation !== 0) {
                        ctx.rotate(wordObj.rotation * Math.PI / 180);
                    }

                    ctx.font = `bold ${wordObj.fontSize}px Inter, Arial, sans-serif`;
                    ctx.fillStyle = wordObj.color;

                    ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                    ctx.shadowBlur = Math.max(2, wordObj.fontSize / 30);
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 2;

                    ctx.fillText(wordObj.text, 0, 0);
                    ctx.restore();

                    addToPixelMap(wordObj.x, wordObj.y, wordObj.width, wordObj.height);
                    placedWords.push(wordObj);

                    clickableWords.push({
                        text: wordObj.text,
                        x: wordObj.x,
                        y: wordObj.y,
                        width: wordObj.width,
                        height: wordObj.height,
                        rotation: wordObj.rotation
                    });
                }
            });

            updateWordCloudStats(items.length, placedWords.length, dataCount || dashboardData.raw.length);
        }

        function adjustColorIntensity(hexColor, intensity) {
            const hex = hexColor.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);

            const newR = Math.round(r * intensity);
            const newG = Math.round(g * intensity);
            const newB = Math.round(b * intensity);

            return `rgb(${newR}, ${newG}, ${newB})`;
        }

        function showEmptyCanvas(ctx, message) {
            const gradient = ctx.createLinearGradient(0, 0, ctx.canvas.width, ctx.canvas.height);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(1, '#f8f9fa');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            ctx.fillStyle = '#999';
            ctx.font = 'bold 28px Inter, Arial';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetY = 2;
            ctx.fillText(message, ctx.canvas.width/2, ctx.canvas.height/2);
        }

        function updateWordCloudStats(totalWords, placedWordsCount, totalPosts) {
            const elements = {
                totalWords: document.getElementById('totalWords'),
                placedWords: document.getElementById('placedWords'),
                successRate: document.getElementById('successRate'),
                info: document.getElementById('wordCloudInfo')
            };

            if (elements.totalWords) elements.totalWords.textContent = totalWords.toLocaleString();
            if (elements.placedWords) elements.placedWords.textContent = placedWordsCount.toLocaleString();

            const successRate = totalWords > 0 ? ((placedWordsCount / totalWords) * 100).toFixed(1) + '%' : '-';
            if (elements.successRate) elements.successRate.textContent = successRate;

            if (elements.info && totalWords > 0) {
                const exclusionInfo = excludedWords.size > 0 ? ` ‚Ä¢ ${excludedWords.size} excluidas` : '';
                elements.info.innerHTML = `<strong>Filtros Aplicados</strong>${exclusionInfo} ‚Ä¢ ${placedWordsCount}/${totalWords} elementos ‚Ä¢ √âxito: ${successRate}`;
            }
        }

        // =============================================================================
        // FUNCIONES DE CONTROL DE GR√ÅFICOS
        // =============================================================================

        function updateChartType(chartName, newType) {
            dashboardData.chartTypes[chartName] = newType;
            updateChart(chartName);
        }

        function updateChartColor(chartName, newColor) {
            dashboardData.chartColors[chartName] = newColor;
            updateChart(chartName);
        }

        function updateChartLimit(chartName, newLimit) {
            dashboardData.chartLimits[chartName] = parseInt(newLimit);
            updateChart(chartName);
        }

        function updateTimelineAxis(newAxis) {
            dashboardData.timelineAxis = newAxis;
            updateChart('timeline');
        }

        function updateChart(chartName) {
            switch (chartName) {
                case 'timeline': createTimeline(); break;
                case 'topPosts': createTopPosts(); break;
                case 'engagement': createEngagement(); break;
                case 'activeUsers': createActiveUsers(); break;
            }
        }

        // =============================================================================
        // FUNCIONES DE UI Y FILTROS
        // =============================================================================

        function populateGlobalCheckboxes() {
            const container = document.getElementById('socialCheckboxes');
            const socialIcons = {
                'twitter': 'üê¶ Twitter',
                'facebook': 'üìò Facebook',
                'instagram': 'üì∏ Instagram',
                'tiktok': 'üéµ TikTok',
                'linkedin': 'üíº LinkedIn',
                'news': 'üì∞ Medios',
                'otros': 'üåê Otros'
            };

            if (!container) return;

            container.innerHTML = '';

            const todasContainer = document.createElement('div');
            todasContainer.className = 'checkbox-container';
            todasContainer.innerHTML = `
                <input type="checkbox" value="todas" id="social-todas" checked onchange="updateSocialFilters()">
                <label for="social-todas">üéØ Todas</label>
            `;
            container.appendChild(todasContainer);

            dashboardData.sources.forEach(source => {
                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = 'checkbox-container';
                checkboxContainer.innerHTML = `
                    <input type="checkbox" value="${source}" id="social-${source}" checked onchange="updateSocialFilters()">
                    <label for="social-${source}">${socialIcons[source] || source}</label>
                `;
                container.appendChild(checkboxContainer);
            });
        }

        function updateSocialFilters() {
            const checkboxes = document.querySelectorAll('#socialCheckboxes input[type="checkbox"]');
            const selectedSources = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedSources.push(checkbox.value);
                }
            });

            dashboardData.filters.social = selectedSources;
            applyFilters();
        }

        function selectAllSocial() {
            document.querySelectorAll('#socialCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateSocialFilters();
        }

        function selectNoneSocial() {
            document.querySelectorAll('#socialCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateSocialFilters();
        }

        function refreshAllData() {
            applyFilters();
        }

        function resetAllFilters() {
            dashboardData.filters = {
                social: ['todas'],
                date: 'all',
                search: ''
            };

            document.getElementById('globalSearch').value = '';
            document.querySelectorAll('#globalDateChips .chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.value === 'all');
            });

            selectAllSocial();
            applyFilters();
        }

        function exportAllData() {
            const data = dashboardData.filtered;
            let csv = 'user_username,text,likes,replies,shared,source,created,sentiment,hashtags,mentions\n';

            data.forEach(post => {
                const hashtags = (post.text.match(/#\w+/g) || []).join('|');
                const mentions = (post.text.match(/@\w+/g) || []).join('|');
                const sentiment = 'neutral'; // Simplified sentiment
                csv += `"${post.user_username}","${post.text.replace(/"/g, '""')}",${post.likes},${post.replies},${post.shared},"${post.source}","${post.created}","${sentiment}","${hashtags}","${mentions}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_completo_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function initEventListeners() {
            document.querySelectorAll('#globalDateChips .chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('#globalDateChips .chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    dashboardData.filters.date = this.dataset.value;
                    applyFilters();
                });
            });

            document.getElementById('globalSearch').addEventListener('input', function() {
                dashboardData.filters.search = this.value;
                applyFilters();
            });
        }

        // =============================================================================
        // FUNCIONES DE MODAL
        // =============================================================================

        function showPostModal(post) {
            document.getElementById('modalUserName').textContent = post.user_name || 'Usuario';
            document.getElementById('modalUsername').textContent = `@${post.user_username}`;
            document.getElementById('modalFollowers').textContent = post.user_followers.toLocaleString();
            document.getElementById('modalDate').textContent = post.created.split('T')[0];
            document.getElementById('modalPostText').textContent = post.text;
            document.getElementById('modalLikes').textContent = post.likes.toLocaleString();
            document.getElementById('modalReplies').textContent = post.replies.toLocaleString();
            document.getElementById('modalShared').textContent = post.shared.toLocaleString();
            document.getElementById('modalSource').textContent = post.source;

            document.getElementById('postModal').style.display = 'block';
        }

        function showUserPosts(username) {
            const userPosts = dashboardData.filtered.filter(post => post.user_username === username);
            const modal = document.getElementById('postModal');
            const content = document.querySelector('.modal-content');

            content.innerHTML = `
                <span class="close" onclick="closeModal()">&times;</span>
                <div class="modal-header">
                    <h3>Publicaciones de ${username}</h3>
                    <p style="color: #666;">${userPosts.length} publicaciones encontradas</p>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${userPosts.map(post => `
                        <div class="post-text" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <strong>${post.source}</strong>
                                <span style="color: #666; font-size: 0.8rem;">${post.created.split('T')[0]}</span>
                            </div>
                            <p style="margin: 10px 0;">${post.text}</p>
                            <div style="display: flex; gap: 15px; font-size: 0.8rem; color: #666;">
                                <span>‚ù§Ô∏è ${post.likes}</span>
                                <span>üí¨ ${post.replies}</span>
                                <span>üîÑ ${post.shared}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn-primary" onclick="closeModal()">Cerrar</button>
                </div>
            `;

            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('postModal').style.display = 'none';
        }

        // =============================================================================
        // INICIALIZACI√ìN
        // =============================================================================

        function initDashboard() {
            const sourceGroups = {};
            dashboardData.raw.forEach(post => {
                const source = post.source || 'otros';
                sourceGroups[source] = (sourceGroups[source] || 0) + 1;
            });
            dashboardData.sources = Object.keys(sourceGroups);

            populateGlobalCheckboxes();
            initEventListeners();
            setupWordCloudEventListeners();
            applyFilters();

            document.getElementById('loading').classList.add('hidden');

            // Show analytics by default
            document.getElementById('analytics-content').classList.add('active');
        }

        // Global function for exclusions
        window.removeExclusion = function(word) {
            excludedWords.delete(word);
            updateExcludedWordsDisplay();
            if (dashboardData.raw.length > 0) {
                generateWordCloud();
            }
        }

        // Event listeners globales
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('csvFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        processCSV(e.target.result);
                    };
                    reader.readAsText(file);
                }
            });

            window.onclick = function(event) {
                const modal = document.getElementById('postModal');
                if (event.target === modal) closeModal();
            };

            // Initialize display values
            document.getElementById('wordCountDisplay').textContent = '35';
            document.getElementById('minFreqDisplay').textContent = '2';
        });
    </script>
</body>
</html>